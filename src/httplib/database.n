using System;
using System.Data;
using System.Reflection;

using Nemerle.IO;
using Nemerle.Utility;


namespace httplib {

public abstract class Database: IDisposable  {

    [Accessor(flags = WantSetter)]
    protected mutable connection: IDbConnection = null;

    public virtual Initialized: bool {
        get { Connection != null }
    }

    public this(connection: string = null) {
        when(connection != null) {
            initialize(connection);
        }
        when(Connection != null) {
            open();
        }
    }

    public Dispose(): void {
        shutdown();
    }

    protected override Finalize(): void {
        shutdown();
    }

    shutdown(): void {
        close();
        Connection.Dispose();
    }

    public abstract initialize(connection: string): void;

    public virtual open(): void {
        Connection.Open();
    }

    public virtual close(): void {
        Connection.Close();
    }

    public withTransaction(lambda: Database -> void): void {
        mutable transaction = null;
        try {
            transaction = Connection.BeginTransaction();
            _ = lambda(this);
            transaction.Commit();
        } catch {
            | _ => {
                print("Rolling back...\n");
                transaction.Rollback();
            }
        }
    }

    public virtual createCommand(query: string = null): Command {
        mutable result = Command(Connection.CreateCommand());
        when(query != null) {
            result.Query = query;
        }
        result;
    }

    /** Load a DB by reflection, given a DLL and type name. */
    public static load(
        path: string, name: string, param: string = null): Database {

        def assembly = Assembly.LoadFrom(path);
        def dbtype = assembly.GetType(name);

        Activator.CreateInstance(dbtype, param) :> Database;
    }
}


public class Command {

    [Accessor]
    protected mutable command: IDbCommand = null;

    public virtual Query: string {
        get { Command.CommandText; }
        set { Command.CommandText = value; }
    }

    public virtual Parameters: IDataParameterCollection {
        get { Command.Parameters; }
    }

    public this(c: IDbCommand) {
        command = c;
    }

    public virtual createParameter(
        name: string = null, value: object = null): Parameter {

        mutable result = Parameter(Command.CreateParameter());

        when(name != null) {
            result.Name = name;
        }
        when(value != null) {
            result.Value = value;
        }

        result;
    }

    public virtual addParameter(param: Parameter): void {
        _ = Parameters.Add(param.Parameter);
    }

    public virtual addParameter(name: string, value: object): void {
        addParameter(createParameter(name, value));
    }

    public virtual executeNonQuery(): int {
        Command.ExecuteNonQuery();
    }

    public virtual executeReader(): IDataReader {
        Command.ExecuteReader();
    }

    public virtual executeScalar(): object {
        Command.ExecuteScalar();
    }
}


public class Parameter {

    [Accessor]
    protected mutable parameter: IDbDataParameter = null;

    public virtual Name: string {
        get { Parameter.ParameterName; }
        set { Parameter.ParameterName = value; }
    }

    public virtual Value: object {
        get { Parameter.Value; }
        set { Parameter.Value = value; }
    }

    public this(p: IDbDataParameter) {
        parameter = p;
    }
}


} // namespace httplib
